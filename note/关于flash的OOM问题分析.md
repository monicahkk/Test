# 关于flash的OOM问题分析

>刚进入应用的时候,内存使用情况如下所示:


<div align="center">
<img src="./关于flash OOM问题的分析/before.png"  alt="Memory Profiler 界面" />
</div>

>然后依次打开其他界面(Activity),再返回主界面,可以看到内存使用情况如下:

<div align="center">
 <img src="./关于flash OOM问题的分析/before2.jpg"  alt="Memory Profiler 界面" />
</div>

>此时,应用经常需要使用的资源应该都已经加载完毕了(实际上GC之后会再小一些),这时候开始进行一些需要大量占用内存空间的操作:

<div align="center">
  <img src="./关于flash OOM问题的分析/before1.jpg"  alt="Memory Profiler 界面" />
</div>

>此时已经点击加载过许多的全屏广告,当普通的全屏广告打开时,内存占用会提升40到50MB,关闭后又回到了打开之前的数值,但广告图片的资源会缓存在内存里,如上图所示.

>为了检测这些资源之后是否会释放,继续点击加载全屏广告.然后加载出了webView形式的全屏广告.此时的内存变化如下图:

<div align="center">
   <img src="./关于flash OOM问题的分析/ADcut.png"  alt="Memory Profiler 界面" />
</div>

>很明显该广告所需的资源非常大,占用了将近150MB的内存,而且基本上是Graphics类型的资源,所以可以得出结论,该广告的资源使用量非常大,在全屏广告弹出前要尽量保证足够的内存空间.之后再次加载了几个全屏广告,退回到主界面:

<div align="center">
   <img src="./关于flash OOM问题的分析/ADcut2.png"  alt="Memory Profiler 界面" />
</div>

>情况如上图所示,广告展示完成后,资源没有释放,依然存在于内存中,多次去手动GC,将应用退至后台,内存占有依然没有变化,那么这个广告的资源肯定泄漏了而且非常严重.这个广告资源本应该退出了theme详情页就释放的,可是现在却到了不杀应用不释放的地步.

>接下来可以分析一下后台oom中的log.主要的log见"内存问题"文档,主要总结了出现次数最多的7个OOM log.分析之后,发现优化方式就2种,要么"硬着头皮上",要么"退而求其次".目前这几个版本的迭代都是使用第二种优化方式:尽量减少其他方面的内存使用.比如说及时解绑listener,增加使用资源的释放时机等减少主进程压力的方式.

>根据LOG分析,OOM发生的时候主要的几个操作有:  

     1.广告资源的I/O操作;

     2.广告中的bitmap资源相关操作;

     3.获取手机系统内应用信息的操作;

     4.锁屏上更新壁纸;

     5.获取系统电池信息中的每个应用信息的操作;


  > 而应用中正常业务逻辑中需要大量使用内存的方面也很多.

    1.对相机句柄的持有,就需要使用大量内存;

    2.cleaner moudle中查询各种数据;

    3.screen Light功能中关于bitmap的操作;

    4.动态图的展示与使用;

    5.下载;

>再深入的话,就要严格安排内存的使用和释放时机了,所以目前的全局分析到此为止,之后主要针对单个问题进行分析处理.

  所以,处理OOM问题,的确不是短时间的事,特别是查找问题的时候,需要从多个角度,多个层次去分析.
-----------------
